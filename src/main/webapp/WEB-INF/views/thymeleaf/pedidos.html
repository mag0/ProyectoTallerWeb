<!DOCTYPE HTML>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Pedidos</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>

<body>
<div th:replace="parts/navbar :: navbar"></div>

<div class="container mt-5">
    <h4>Filtrar</h4>
    <div class="row">
        <div class="col-md-4">
            <label for="fechaFiltro" class="form-label">Filtrar por fecha</label>
            <input type="date" id="fechaFiltro" onchange="filtrarPedidos('fecha')" class="form-control">
        </div>
        <div class="col-md-4">
            <label for="codigoFiltro" class="form-label">Filtrar por código</label>
            <input type="text" id="codigoFiltro" placeholder="Filtrar por código" onkeyup="filtrarPedidos('codigo')" class="form-control">
        </div>
        <div class="col-md-4">
            <label for="buscarPedido" class="form-label">Buscar pedido por nombre</label>
            <div class="input-group">
                <input type="text" id="buscarPedido" placeholder="Nombre pedido" onkeyup="buscarPedido()" class="form-control">
                <button class="btn btn-outline-secondary" type="button" id="button-addon2">Buscar</button>
            </div>
        </div>
    </div>
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-end">
            <li class="page-item"><a class="page-link" href="#" onclick="cargarPaginaAnterior()">Anterior</a></li>
            <li class="page-item"><a class="page-link" href="#" onclick="cargarPaginaSiguiente()">Siguiente</a></li>

        </ul>
    </nav>

    <section class="row mt-5">
        <div class="col-md-6" th:each="pedido, pedidoIndex : ${pedidos}">
            <div class="card mb-3">
                <div class="card-header">
                    <h4 class="card-title" th:text="${pedido.nombre}"></h4>
                </div>
                <div class="card-body d-flex align-items-center" th:id="'pedido_' + ${pedidoIndex.index}">
                    <img src="https://imgs.search.brave.com/k-wXhcDyWNTGf5moCJQ7a408BqCDhUTXS5gxhfvxJvc/rs:fit:860:0:0/g:ce/aHR0cHM6Ly93d3cu/cG5nbWFydC5jb20v/ZmlsZXMvMTEvQmxh/bmstUGFja2FnZS1Q/TkctUGljLnBuZw" alt="Pedido" width="130px" height="130px">
                    <div class="ml-2 card-text">
                        <p th:text="'Codigo: ' + ${pedido.codigo}"></p>
                        <p th:text="'Entrega: ' + ${pedido.fecha}" class="fecha-entrega"></p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <form th:action="@{'/pedidos/cancelar/' + ${pedido.id}}" method="get">
                            <button class="btn btn-danger" type="submit">Eliminar</button>
                        </form>
                        <div>
                            <a th:href="@{'/pedidos/'+${pedido.id}+'/asignar'}" class="btn btn-primary">Despachar</a>
                            <a th:href="@{'/pedidos/' + ${pedido.id} + '/reprogramar-pedido'}" class="btn btn-secondary">Reprogramar</a>
                            <a th:href="@{'/pedidos/detalles/' + ${pedido.id}}" class="btn btn-info">Ver Detalles</a>
                            <a th:href="@{'/pedidos/' + ${pedido.id} + '/editar'}" class="btn btn-warning">Editar</a>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <button type="button" class="btn btn-primary mt-5" onclick="mostrarVentanaEmergente()">Sugerir</button>
</div>

<!-- Ventana Emergente -->
<div id="ventanaEmergente" class="modal fade">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vehículos disponibles para viajes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="seleccionVehiculosForm">
                    <div class="form-check" th:each="vehiculo : ${vehiculos}">
                        <input class="form-check-input" type="checkbox" name="vehiculo" th:id="'vehiculo' + ${vehiculo.id}" th:value="${vehiculo.id}">
                        <label class="form-check-label" th:for="'vehiculo' + ${vehiculo.id}" th:text="${vehiculo.nombre}">
                            Vehículo 1
                        </label>
                    </div>
                    <button type="button" onclick="enviarSeleccion()" class="btn btn-primary mt-3">Enviar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.2.0/js/bootstrap.min.js"></script>
<script>
    function filtrarPedidos(tipoFiltro) {
        var filtro = "";

        // Dependiendo del tipo de filtro, obtenemos el valor correspondiente
        if (tipoFiltro === 'fecha') {
            filtro = new Date(document.getElementById("fechaFiltro").value);
        } else if (tipoFiltro === 'codigo') {
            filtro = document.getElementById("codigoFiltro").value.toLowerCase();
        }

        // Iteramos sobre cada pedido
        var pedidos = document.getElementsByClassName("card");
        for (var i = 0; i < pedidos.length; i++) {
            var fechaPedido = new Date(pedidos[i].querySelector(".fecha-entrega").textContent);
            var codigoPedido = pedidos[i].querySelector(".card-text").textContent.toLowerCase();

            // Comparamos la fecha o el código del pedido con el filtro correspondiente
            if ((tipoFiltro === 'fecha' && !sonFechasIguales(fechaPedido, filtro)) ||
                (tipoFiltro === 'codigo' && !codigoPedido.includes(filtro))) {
                pedidos[i].style.display = "none";
            } else {
                pedidos[i].style.display = "block";
            }
        }
    }

    function sonFechasIguales(fecha1, fecha2) {
        return fecha1.getFullYear() === fecha2.getFullYear() &&
            fecha1.getMonth() === fecha2.getMonth() &&
            fecha1.getDate() === fecha2.getDate();
    }


    function mostrarVentanaEmergente() {
        document.getElementById("ventanaEmergente").style.display = "block";
    }

    function cerrarVentanaEmergente() {
        document.getElementById("ventanaEmergente").style.display = "none";
    }

    function enviarSeleccion() {
        var form = document.getElementById("seleccionVehiculosForm");
        var checkboxes = form.querySelectorAll('input[name="vehiculo"]:checked');
        var vehiculosSeleccionados = [];

        checkboxes.forEach(function(checkbox) {
            vehiculosSeleccionados.push(checkbox.value);
        });

        // Aquí puedes hacer lo que quieras con la información seleccionada,
        // por ejemplo, enviarla a través de una solicitud HTTP o procesarla localmente.
        console.log("Vehículos seleccionados:", vehiculosSeleccionados);

        // Cerrar la ventana emergente después de enviar la selección
        cerrarVentanaEmergente();
    }

    async function asignarPedido(id) {
        const url = `/spring/pedidos/${id}/asignar`;
        const requestBody = {
            vehiculoId: id
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',  // Asegura que se envíe como JSON
                    'Accept': 'application/json'  // Asegura que se espera una respuesta JSON
                },
                body: JSON.stringify(requestBody)  // Convertir el cuerpo de la solicitud a JSON
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Response:', data);
        } catch (error) {
            console.error('Error:', error);
        }
    };
    document.getElementById('eliminarPedidoForm').addEventListener('submit', function() {
        // Recargar la página después de enviar el formulario de eliminación
        location.reload();
    });
    let paginaActual = 1;

    async function cargarPagina(pagina) {
        try {
            const response = await fetch(`/spring/pedidos?page=${pagina}`);
            if (!response.ok) throw new Error('Error al cargar pedidos');
            const pedidos = await response.json();
            actualizarVistaPedidos(pedidos);
            paginaActual = pagina;
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar pedidos.', 'danger');
        }
    }

    function cargarPaginaAnterior() {
        if (paginaActual > 1) cargarPagina(paginaActual - 1);
    }

    function cargarPaginaSiguiente() {
        cargarPagina(paginaActual + 1);
    }

    function buscarPedido() {
        const query = document.getElementById('buscarPedido').value.toLowerCase();
        const pedidos = document.querySelectorAll('.card');
        pedidos.forEach(pedido => {
            const nombre = pedido.querySelector('.card-title').textContent.toLowerCase();
            if (nombre.includes(query)) {
                pedido.style.display = 'block';
            } else {
                pedido.style.display = 'none';
            }
        });
    }
    

</script>
</body>
</html>